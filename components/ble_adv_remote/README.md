# ble_adv_remote

## Description
Allows to capture BLE ADV Commands generated by Remotes or Phone Apps and either process actions or redirect those Commands to a [ble_adv_controller](../ble_adv_controller/README.md).

## Variables
- **encoding** (Required): the encoding, as described in ble_adv_controller
- **variant** (Optional): the variant, as described in ble_adv_controller
- **forced_id** (Optional): the forced_id, as described in ble_adv_controller
- **index** (Optional): the index, as described in ble_adv_controller
- **commands_as_toggle** (Optional, Default: False). Considers any 2 position commands as toggle (Light ON/OFF, Secondary Light ON/OFF, Fan Direction, Fan Oscillation), meaning whatever command received by the remote will change the state of the controlled/published ble_adv_controller. This is especially needed for Physical Remote.
- **level_count** (Optional, Default: 10). The number of different levels for brightness and color temperature in order to switch from low to high level using the Remote + or - buttons. Be careful that some remotes send 2 commands on each button pressed.
- **cycle** (Optional, Default: []). The list of [cold %, warm %] to use as an iteration when the K Switch button is used to switch in between color temperature.

## Triggers
- **on_command**: 
  - Description: Triggered when a Command is received and decoded by the remote. The variable `x` of class `BleAdvGenCmd` is available for use in lambdas.
  - Options: None

## Actions
- **unpair**:
  - Description: TRIES to unpair the configured remote from the controlled device by issuing an UNPAIR command. It may work or not, depending on the device and the knowledge of the remote protocol.
  - Options:
    - **id**: the remote id

## Finding Configuration
The main parameters of the configuration of a ble_adv_remote (encoding/variant/forced_id/index) can be found using the [ble_adv_handler](../ble_adv_handler/README.md) to listen to the traffic generated by a phone app or a remote.

## Basic Example configurations 
In these configurations, the encoding / variant / index / forced_id are found by listening the traffic using the previous step. Do NOT use the values in the example, they are fake.

Those configurations are based on the fact a ble_adv_controller is existing and controls the device.

### Basic configuration in publishing mode
This mode is to be used in case the Physical remote / Phone app you want to use is PAIRED to the device to be controlled: the Publishing mode allows to publish commands to an existing [ble_adv_controller](../ble_adv_controller/README.md) that will update its state (and the HA state) based on what is listened from the remote, but without triggering any command to the controlled device.

This results in the following flows:

Physical Remote -----> ble_adv_remote ---(P)--> ble_adv_controller ----> HA Entities
                 \---> Controlled Device

HA Entities     --(C)--> ble_adv_controller  ----> Controlled Device

```yaml
ble_adv_controller:
  - id: my_controller_id
    ...

ble_adv_remote:
  - id: my_remote_id
    encoding: xxxxxx
    variant: vx
    forced_id: 0xAAAAAA
    index: 1
    publishing: my_controller_id
```

Advantages: very reactive as the remote is controlling the device directly.

Drawbacks: if some commands are not captured by the ble_adv_remote, the HA and the device may not be in sync.

### Basic configuration in controlling mode
This mode is to be used in case the Physical remote / Phone app you want to use is NOT PAIRED to the device to be controlled: the Controlling mode allows to send commands to an existing [ble_adv_controller](../ble_adv_controller/README.md) that will update its state (and the HA state) based on what is listened from the remote, and send the command to the controlled device.

This results in the following flows:

Physical Remote -----> ble_adv_remote ---(C)--> ble_adv_controller ----> HA Entities
                                                                    \--> Controlled Device

HA Entities  --(C)--> ble_adv_controller  ----> Controlled Device

```yaml
ble_adv_controller:
  - id: my_controller_id
    ...

ble_adv_remote:
  - id: my_remote_id
    encoding: xxxxxx
    variant: vx
    forced_id: 0xAAAAAA
    index: 1
    controlling: my_controller_id
```

Advantages: the ble_adv_controller is the only one controlling the device, so the device state is always in sync with HA.

Drawbacks: there is one supplementary step to control the device using the remote, which means a bit of delay and some commands lost sometimes


### Basic configuration in controlling mode with options
Same as previous, adding common options for Remote.
The cycle is only needed if you want to control / reproduce what is done by your lamp when the Color Temperature switch button is used

```yaml
ble_adv_controller:
  - id: my_controller_id
    ...

ble_adv_remote:
  - id: my_remote_id
    encoding: xxxxxx
    variant: vx
    forced_id: 0xAAAAAA
    index: 1
    controlling: my_controller_id
    commands_as_toggle: true
    cycle:
      - [0,10%]     # Warm, Low Brightness
      - [0,50%]     # Warm, Middle Brightness
      - [0,100%]    # Warm, High Brightness
      - [100%,100%] # Neutral, High Brightness
      - [50%,50%]   # Neutral, Middle Brightness
      - [10%,10%]   # Neutral, Low Brightness
      - [10%,0]     # Cold, Low Brightness
      - [50%,0]     # Cold, Middle Brightness
      - [100%,0]    # Cold, High Brightness

```

### Unpair a physical remote 
If you want to use the controlling mode but your physical remote is already PAIRED to the controlled device, you can send an UNPAIR command while simulating the remote and it _may_ unpair the remote.

To do so, simply call the HA service/action `ESPHome: <my_device_name>_unpair_<my_remote_id>` from the [HA developer dashboard](https://www.home-assistant.io/docs/tools/dev-tools/).

## Example configurations for advanced users
In these configurations, the encoding / variant / index / forced_id are found by listening the traffic using the previous step. Do NOT use the values in the example, they are fake.
Those configurations are based on the use of ESPHome Lambdas.

### Basic Config that logs the commands
```yaml
ble_adv_remote:
  - id: my_remote
    encoding: xxxxxx
    variant: vx
    forced_id: 0xAAAAAA
    index: 1
    on_command:
      then:
        - lambda: 'ESP_LOGD("Remote", "Command: %s", x.str().c_str());'
```
One can define any action based on the `on_command` trigger, the variable `x` is a `BleAdvGenCmd` being available for lambdas, in particular `x.cmd` gives the `CommandType`.

### Config that triggers events in Home Assistant
```yaml
ble_adv_remote:
  - id: my_remote
    encoding: xxxxxx
    variant: vx
    forced_id: 0xAAAAAA
    index: 1
    on_command:
      then:
        - homeassistant.event:
            event: esphome.the_event_name_as_i_want_in_ha
            data_template:
              cmd: '{{ my_cmd }}'
              param: '{{ my_param }}'
            variables:
              my_cmd: !lambda 'return x.cmd;'
              my_param: !lambda 'return x.param;'
```

Also based on the use of lambdas, see [api ha event doc](https://esphome.io/components/api#api-homeassistant-event-action).

### Button in HA to unpair the remote
```yaml
ble_adv_remote:
  - id: my_remote
    encoding: xxxxxx
    variant: vx
    forced_id: 0xAAAAAA
    index: 1

button:
  - platform: template
    name: Remote UnPair
    entity_category: config
    on_press:
      ble_adv_remote.unpair: my_remote
```

## Known limits
There are as many Remote types as there are chandelier models. Contrarly to the Phone Apps which are fully known, the commands generated by the remotes may be completely different and only used by this model.

Still most of them will probably use protocols very similar to the ones use by the Phone App, as it would be easier for the Controlled Device to support only one protocol.

If you manage to capture the config for the Phone App but not for the Remote, you can open us an Issue with the raw commands generated by the main commands of your remote, as what was done [here](https://github.com/aronsky/esphome-components/issues/21).